# __UNIDAD 2:__ SERVIDORES WEB

### Links externos de esta unidad:
- üìä [Diapositivas de la Unidad 2](http://jamj2000.github.io/despliegueaplicacionesweb/2/diapositivas)  
- üìö [Actividades de la Unidad 2](http://jamj2000.github.io/despliegueaplicacionesweb/2/actividades)

- - -

## √çndice
- 1 - Introducci√≥n
- 2 - Apache: Instalaci√≥n
- 3 - Apache: Hosts virtuales
- 4 - Apache: Autenticaci√≥n b√°sica
- 5 - Apache: Servidor HTTPS 


- - -

## 1Ô∏è‚É£ - Introducci√≥n


### 1.1 - En esta Unidad aprenderemos a

- Reconocer los par√°metros de administraci√≥n m√°s importantes del servidor Web.
- Crear y configurar sitios virtuales.
- Establecer mecanismos para asegurar las comunicaciones entre el cliente y el servidor.
- Realizar los ajustes necesarios para la implantaci√≥n de aplicaciones en el servidor Web.

- - -

## 2Ô∏è‚É£ - Apache: Instalaci√≥n

**`apt  install  apache2`**


### 2.1 - Caracter√≠sticas

- Apache2 es el servidor web m√°s usado actualmente.
- Es **software libre**.
- Tiene un **dise√±o modular**. 
- Directorio de configuraci√≥n principal: **`/etc/apache2`**.
- Archivo de configuraci√≥n principal: **`apache2.conf`**.
- M√≥dulos en:
  - **`mods-available`** (disponibles)
  - **`mods-enabled`** (habilitados)
- Sitios en:
  - **`sites-available`** (disponibles)
  - **`sites-enabled`** (habilitados)


### 2.2 - Archivos y carpetas

```
‚îú‚îÄ‚îÄ apache2.conf
‚îú‚îÄ‚îÄ conf-available
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ localized-error-pages.conf
‚îú‚îÄ‚îÄ conf-enabled
‚îú‚îÄ‚îÄ envvars
‚îú‚îÄ‚îÄ magic
‚îú‚îÄ‚îÄ mods-available
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ssl.conf
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ssl.load
‚îú‚îÄ‚îÄ mods-enabled
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ssl.conf -> ../mods-available/ssl.conf
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ssl.load -> ../mods-available/ssl.load
‚îú‚îÄ‚îÄ ports.conf
‚îú‚îÄ‚îÄ sites-available
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ 000-default.conf
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ default-ssl.conf
‚îî‚îÄ‚îÄ sites-enabled
    ‚îî‚îÄ‚îÄ 000-default.conf -> ../sites-available/000-default.conf
```


### 2.3 - Gesti√≥n del servicio

```bash
systemctl  start   apache2  # service apache2 start
systemctl  restart apache2  # service apache2 restart
systemctl  stop    apache2  # service apache2 stop
systemctl  status  apache2  # service apache2 status

# Enable lo activa en el inicio, a diferencia de start, que lo inicia si estaba parado.
systemctl  enable  apache2  

# Lo desactiva del inicio autom√°tico del equipo, a diferencia de stop, que lo para.
systemctl  disable apache2
```


### 2.4 - Comandos

```bash 
a2dismod   # Deshabilitar m√≥dulo 
a2enmod    # Habilitar m√≥dulo

a2dissite  # Deshabilitar sitio
a2ensite   # Habilitar sitio
```

- - -

## 3Ô∏è‚É£ - Apache: Hosts virtuales


### 3.1 - Caracter√≠sticas

- Apache2 permite tener varios sitios web compartiendo una direcci√≥n IP.
- Sitio por defecto en **`/var/www/html`**.
- Otros sitios virtuales en:
  - **`/var/www/sitio1`**, **`/var/www/sitio2`**, ...
- Por cada sitio virtual debe existir un archivo de configuraci√≥n.
- Dicho archivo debe alojarse en:
  - **`/etc/apache2/sites-available`**  


### 3.2 - Archivo de configuraci√≥n

**`/etc/apache2/sites-available/sitio.conf`**

```xml
<VirtualHost *:80> 
  ServerName www.sitio.com
  ServerAdmin webmaster@sitio.com
  DocumentRoot /var/www/sitio

</VirtualHost>
```


### 3.3 - Comandos

```bash
a2dissite  sitio           # Deshabilita sitio
a2ensite   sitio           # Habilita sitio
service  apache2  restart  # Reinicia el servidor
```


### 3.4 - Resoluci√≥n de nombres

- Cuando escribimos una URL en el navegador, √©sta debe ser traducida a una IP.
- Este procedimiento se conoce como resoluci√≥n de nombres.
- Lo habitual es que se encargue el servicio DNS.
- Pero una soluci√≥n r√°pida para pruebas, es editar el archivo **`/etc/hosts`**.

```
192.168.1.135   www.misitio.com
192.168.1.135   www.mimoodle.com
```

- - -

## 4Ô∏è‚É£ - Apache: Autenticaci√≥n b√°sica


### 4.1 - Caracter√≠sticas

- El usuario debe identificarse para acceder a un sitio o carpeta.
- Credenciales de usuario/contrase√±a.
- La constrase√±a se guarda cifrada en un archivo al que tiene acceso Apache.
- Para cifrar, usamos el comando **`htpasswd`**.
- Indicamos mediante directivas el tipo de autenticaci√≥n y usuarios permitidos.
- El tr√°fico no viaja cifrado. No es un mecanismo muy seguro. 
- Actualmente se usa poco.


### 4.2 - Comandos

```bash
mkdir     /var/www/passwd   # creamos directorio
cd        /var/www/passwd   # entramos en directorio
touch     .htpasswd         # creamos archivo
htpasswd  .htpasswd  jose   # a√±adimos usuario jose
```
Ejecutar los comandos como usuario **root**.


### 4.3 - Directivas de autenticaci√≥n

// La clave privada la tiene el servidor. Cuando alguien se conecta al servidor, √©ste da una clave p√∫blica junto al certificado, y el servidor a partir de la clave privada, se encarga de desencriptar la comunicaci√≥n.

```xml

// Estas directivas se a√±aden en nuestro sitio de la ruta /etc/apache2/sites-available/misitio.conf

<VirtualHost *:80> 
  ServerName www.sitio.com 
  ServerAdmin webmaster@localhost 
  DocumentRoot /var/www/sitio

  <Directory /var/www/sitio> 
    AuthType Basic
    AuthName "Zona Privada"
    AuthUserFile /var/www/passwd/.htpasswd
    Require user jose juan
  </Directory>
</VirtualHost>
```

- - -

## 5Ô∏è‚É£ - Apache: Servidor HTTPS


### 5.1 - Caracter√≠sticas

- Necesita de un certificado X.509.
- Dos tipos de certificados:
  - Autofirmados.
  - Firmados por una CA (Autoridad de Certificaci√≥n).
- Permite que el tr√°fico viaje cifrado.
- Adicionalmente tambi√©n permite autenciaci√≥n si el certificado est√° firmado por una CA reconocida.
- HTTPS = HTTP + SSL/TLS

**IMPORTANTE**: La negociaci√≥n SSL es dependiente totalmente de la IP, as√≠ que no puedes servir distintos certificados en una misma IP.


### 5.2 - Obtener un certificado

- **`make-ssl-cert`**
- **`openssl`**
- **`xca`**


### 5.3 - make-ssl-cert

```bash
make-¬≠ssl-¬≠cert  /usr/share/ssl¬≠-cert/ssleay.cnf  /etc/ssl/private/nombre¬≠-sitio.pem
```
El ejecutable `make-ssl-cert` viene en el paquete `ssl-cert`


### 5.4 - openssl

```bash
# Generamos clave privada
openssl genrsa -out key 1024

# Generamos CSR y firmamos con nuestra clave privada
openssl req -new -key key -out csr
openssl x509 -req -days 365 -in csr -signkey key -out crt

# Copiamos clave y certificado en el destino
cat key crt > /etc/ssl/private/nombre-sitio.pem
```

__CSR = Certificate Signing Request (solicitud de firma de certificado)__   
El CSR no est√° firmado. Incluye nuestra clave p√∫blica, que luego se manda a certificar a la AC.


### 5.5 - xca

![xca](assets/xca.png)


### 5.6 - Archivo de configuraci√≥n

**`/etc/apache2/sites-available/default-ssl.conf`**

```xml
<VirtualHost _default_:443> 
  ServerName nombre¬≠-dominio-¬≠sitio
  DocumentRoot /var/www/html
  
  SSLEngine on
  SSLCertificateFile  /etc/ssl/private/nombre-¬≠sitio.pem
  ...
  
  <Directory /var/www/html> 
    SSLRequireSSL
    ...
  </Directory>
</VirtualHost>
```


### 5.7 - Comandos

```bash
a2enmod   ssl

a2dissite default-ssl
a2ensite  default-ssl

service  apache2  restart
```


### 5.8 - Resultado

![https](assets/https.png)



